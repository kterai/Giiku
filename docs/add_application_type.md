# 新しい申請種別を追加する手順

このドキュメントでは、技育システムに新しい申請種別を開発・登録するための流れを初心者向けに詳しく解説します。既存の `TravelRequest` 実装を参考に、以下の手順で作業を進めてください。

## 本書の目的

新規申請種別の作成からテスト実施まで、必要な処理を順番に追えるようまとめています。手順ごとに実施ポイントを確認しながら進めてください。

## 0. 準備

1. ローカル環境でプロジェクトを最新状態へ `git pull` します。
2. `./gradlew bootRun` でアプリケーションが起動することを確認します。
3. DB マイグレーションが正しく適用されるよう `docker-compose up -d` で DB を起動します。
4. 既存の申請種別 (例:`TravelRequest`) のコードを一通り読み、構成を把握しておきます。

## 1. 申請種別マスタの登録

1. 管理画面の「申請種別マスタ」から名称・コード・説明を入力してレコードを追加します。
   - プログラムから登録する場合は `ApplicationTypeService#create` を呼び出します。
2. コードは `ApplicationNumber#isValidTypeCode` で使用される 2 文字の英大文字を推奨します。既存コードと重複しないよう注意してください。
3. 既存環境へ追加する場合は Flyway マイグレーションに INSERT 文を記述します。

## 2. 承認ルートの設定

1. 新規申請種別用の承認ルートを `approval_routes` テーブルへ登録します。
   - 管理画面の「承認ルート設定」から登録するか、`ApprovalRouteService` を利用します。
2. 承認ステップは `display_order` で並び順を管理し、必要に応じて部署や権限、特定承認者を指定します。
3. テスト環境で申請から承認まで流れるか必ず確認してください。

## 3. 申請詳細テーブル・サービスの実装

1. 申請種別固有の項目を格納するエンティティを `jp.co.apsa.giiku.domain.entity` 配下に作成します。
2. 対応するリポジトリ (`*Repository`) とサービス (`*Service`) を実装します。メソッド名は `create...` や `update...` など規約に沿って命名します。
3. コントローラーと Thymeleaf テンプレートを用意し、画面から登録・承認できるようにします。
4. 実装例として `TravelRequestDetails` と `TravelRequestService` を参照してください。

## 4. 申請番号の種別コード追加

1. `ApplicationNumber` クラス内の `isValidTypeCode` と `getTypeName` に新しいコードと名称を追記します。
2. コード追加後は、既存申請番号生成処理でエラーが出ないか手動テストを行います。

## 5. テストとマイグレーション

1. 追加した機能に対する単体テスト・統合テストを `src/test/java` 配下へ作成します。テスト命名は `should...` 形式を推奨します。
2. Flyway のマイグレーションファイルを作成し、新しいテーブルや初期データを登録します。
3. `./gradlew test` を実行し、既存テストを含めすべて成功することを確認してください。

## 6. 注意点まとめ

- 種別コードが重複すると申請番号が生成できないため、事前に既存コードを確認します。
- 承認ルートを変更した場合は、古い申請データとの整合性にも注意してください。
- 画面表示用のメッセージは `messages.properties` に追加し、国際化対応を忘れないようにします。
- 実装後は必ずローカル環境で申請から承認までの一連の操作を試し、想定通り動くかチェックします。

以上が申請種別を追加する際の具体的な手順とポイントです。システムの要件に合わせて適宜調整してください。
