<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{_layouts/lecture}">
<head>
    <meta charset="UTF-8">
    <title th:text="${lecture.title}">Lecture</title>
    <link rel="stylesheet" th:href="@{/webjars/prismjs/1.29.0/themes/prism-tomorrow.min.css}">
</head>
<body class="bg-light text-dark">

<div layout:fragment="pageheader"
     th:replace="~{_fragments/headers :: page(title=${pageTitle}, breadcrumb=${breadcrumbs})}"></div>

<section layout:fragment="content">
    <main class="pt-5">
        <!-- 講義ヘッダー -->
        <header class="bg-primary text-white py-4 shadow">
            <div class="container px-4">
                <h1 class="text-center fw-bold mb-2">
                    <i class="fas fa-coffee me-2"></i>
                    <span th:text="${lecture.title}">講義タイトル</span>
                </h1>
                <p class="text-center text-light fs-5" th:text="${lecture.description}">講義説明</p>
                <div class="mt-3 text-center small">
                    <span class="badge bg-secondary me-2">
                        所要時間: <span th:text="${lecture.durationMinutes}">90</span>分
                    </span>
                    <span class="badge bg-secondary me-2"
                          th:if="${lecture.difficultyLevel}">
                        レベル: <span th:text="${lecture.difficultyLevel}">初級</span>
                    </span>
                    <span class="badge bg-secondary">
                        講義番号: <span th:text="${lecture.lectureNumber}">1</span>
                    </span>
                </div>
            </div>
        </header>

        <div class="container px-4 py-4">
            <!-- 学習目標セクション -->
            <section class="bg-white rounded shadow p-4 mb-4" th:if="${goals != null and !goals.isEmpty()}">
                <h2 class="fw-bold text-primary mb-4">
                    <i class="fas fa-target me-2"></i>本日の学習目標
                </h2>
                <div class="d-flex flex-column gap-3">
                    <div th:each="goal : ${goals}">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-check-circle text-primary me-2 mt-1"></i>
                            <span th:text="${goal.goalDescription}">学習目標項目</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- コンテンツチャプターセクション -->
            <div th:each="chapter, iterStat : ${contentChapters}" class="mb-4" th:if="${contentChapters != null and !contentChapters.isEmpty()}">
                <section class="bg-white rounded shadow p-4">
                    <h2 class="fw-bold mb-4 text-primary"
                        th:text="${chapter.chapterNumber + '. ' + chapter.title}">
                        チャプタータイトル
                    </h2>

                    <!-- チャプター説明 -->
                    <div th:if="${chapter.description}" class="mb-4">
                        <p th:text="${chapter.description}">チャプター説明</p>
                    </div>

                    <!-- チャプターの所要時間 -->
                    <div th:if="${chapter.durationMinutes}" class="mb-4">
                        <span class="badge bg-secondary">
                            所要時間: <span th:text="${chapter.durationMinutes}">30</span>分
                        </span>
                    </div>

                    <!-- このチャプターのコンテンツブロック -->
                    <th:block th:with="blocks=${chapterContentBlocks[chapter.id]}">
                        <div th:if="${blocks != null and !blocks.isEmpty()}">
                            <h3 class="fw-semibold mb-4 text-secondary">コンテンツ</h3>
                            <div th:each="block : ${blocks}" class="mb-4 p-4 border rounded">
                                <h4 class="fw-semibold text-dark mb-2" th:text="${block.title}">ブロックタイトル</h4>

                                <div class="bg-light p-3 rounded mb-3">
                                    <span class="fw-semibold text-muted text-uppercase small"
                                          th:text="${block.blockType}">ブロック種別</span>
                                </div>

                                <div th:if="${block.content}">
                                    <div th:switch="${#strings.toLowerCase(block.blockType)}">
                                        <!-- テキストコンテンツ -->
                                        <div th:case="'text'">
                                            <pre class="formatted-text" th:utext="${block.content}">コンテンツ内容</pre>
                                        </div>

                                        <!-- コードブロック -->
                                        <div th:case="'code'" class="code-block mb-4">
                                            <pre><code class="language-java" th:text="${block.content}">コード内容</code></pre>
                                        </div>

                                        <!-- 画像 -->
                                        <div th:case="'image'" class="text-center">
                                            <img th:src="${block.content}" th:alt="${block.title}" class="img-fluid mx-auto d-block rounded">
                                        </div>

                                        <!-- リスト -->
                                        <div th:case="'list'">
                                            <pre class="formatted-text" th:utext="${block.content}">リスト内容</pre>
                                        </div>

                                        <!-- その他のコンテンツ -->
                                        <div th:case="*">
                                            <pre class="formatted-text" th:utext="${block.content}">その他のコンテンツ</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </th:block>

                    <!-- コンテンツブロックがない場合のメッセージ -->
                    <div th:if="${chapterContentBlocks[chapter.id] == null || chapterContentBlocks[chapter.id].isEmpty()}">
                        <p>この講義のコンテンツは現在準備中です。しばらくお待ちください。</p>
                    </div>
                </section>
            </div>

            <!-- 理解度テストセクション -->
            <section th:if="${quizQuestions != null and !quizQuestions.isEmpty()}" class="bg-white rounded shadow p-4 mb-4">
                <h2 class="fw-bold text-primary mb-4">
                    <i class="fas fa-question-circle me-2"></i>理解度テスト
                </h2>
                <div th:each="quiz, quizStat : ${quizQuestions}" class="mb-4">
                    <h3 class="fw-semibold mb-2" th:text="${quiz.questionNumber + '. ' + quiz.questionText}">問題文</h3>
                    <ul class="list-unstyled ms-3">
                        <li th:if="${quiz.optionA}" th:text="${'A. ' + quiz.optionA}">選択肢A</li>
                        <li th:if="${quiz.optionB}" th:text="${'B. ' + quiz.optionB}">選択肢B</li>
                        <li th:if="${quiz.optionC}" th:text="${'C. ' + quiz.optionC}">選択肢C</li>
                        <li th:if="${quiz.optionD}" th:text="${'D. ' + quiz.optionD}">選択肢D</li>
                        <li th:if="${quiz.optionE}" th:text="${'E. ' + quiz.optionE}">選択肢E</li>
                        <li th:if="${quiz.optionF}" th:text="${'F. ' + quiz.optionF}">選択肢F</li>
                    </ul>
                    <button sec:authorize="hasAnyRole('ADMIN','INSTRUCTOR')"
                            th:onclick="'showAnswer(\'answer' + ${quizStat.count} + '\')'"
                            class="btn btn-primary d-flex align-items-center gap-2 mt-2">
                        <i class="fas fa-eye"></i>
                        <span class="answer-toggle-label">回答を表示</span>
                    </button>
                    <div sec:authorize="hasAnyRole('ADMIN','INSTRUCTOR')"
                         th:id="'answer' + ${quizStat.count}"
                         class="answer-content">
                        <h4 class="fw-semibold mb-2">正解：</h4>
                        <p th:text="${quiz.correctAnswer}">正解</p>
                        <p th:if="${quiz.explanation}" th:utext="${quiz.explanation}">解説</p>
                    </div>
                </div>
            </section>

            <!-- 演習問題セクション -->
            <section th:if="${exercises != null and !exercises.isEmpty()}" class="bg-white rounded shadow p-4 mb-4">
                <h2 class="fw-bold text-primary mb-4">
                    <i class="fas fa-dumbbell me-2"></i>演習問題
                </h2>

                <div th:each="exercise, exStat : ${exercises}" class="border rounded p-4 mb-4">
                    <h3 class="fw-bold text-primary mb-3"
                        th:text="${'演習問題' + exercise.questionNumber}">演習問題タイトル</h3>
                    <p class="mb-3" th:utext="${exercise.questionText}">問題説明</p>

                    <button th:onclick="'toggleAnswer(\'answer' + ${exStat.count} + '\')'"
                            class="btn btn-primary d-flex align-items-center gap-2">
                        <i class="fas fa-eye"></i>
                        <span class="answer-toggle-label">回答例を表示</span>
                    </button>

                    <div sec:authorize="hasAnyRole('ADMIN','INSTRUCTOR')"
                         th:id="'answer' + ${exStat.count}"
                         class="answer-content">
                        <h4 class="fw-semibold mb-2">回答例：</h4>
                        <p th:utext="${exercise.correctAnswer}">回答</p>
                        <p th:if="${exercise.explanation}" th:utext="${exercise.explanation}">解説</p>
                    </div>
                </div>
            </section>
            <!-- 追加リソース -->
            <section th:if="${additionalResources != null and !additionalResources.isEmpty()}" class="bg-white rounded shadow p-4 mb-4">
                <h2 class="fw-bold text-primary mb-4">
                    <i class="fas fa-link me-2"></i>追加学習リソース
                </h2>
                <div class="row row-cols-1 row-cols-md-2 g-4">
                    <div th:each="resource : ${additionalResources}" class="col">
                        <div class="border rounded p-4 h-100">
                            <h4 class="fw-semibold mb-2" th:text="${resource.title}">リソースタイトル</h4>
                            <p class="text-muted small mb-2" th:text="${resource.description}">説明</p>
                            <a th:href="${resource.url}" target="_blank"
                               class="text-primary small text-decoration-none">
                                <i class="fas fa-external-link-alt me-1"></i>
                                <span th:text="${resource.linkText ?: 'リンクを開く'}">リンクテキスト</span>
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ナビゲーション -->
            <section class="d-flex justify-content-between align-items-center bg-white rounded shadow p-4">
                <div>
                    <a th:if="${previousLecture}"
                       th:href="@{/lecture/{id}(id=${previousLecture.id})}"
                       class="btn btn-secondary d-inline-flex align-items-center px-4 py-2">
                        <i class="fas fa-arrow-left me-2"></i>
                        前の講義: <span th:text="${previousLecture.title}">前の講義</span>
                    </a>
                </div>
                <div>
                    <a th:if="${nextLecture}"
                       th:href="@{/lecture/{id}(id=${nextLecture.id})}"
                       class="btn btn-primary d-inline-flex align-items-center px-4 py-2">
                        次の講義: <span th:text="${nextLecture.title}">次の講義</span>
                        <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                </div>
            </section>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        function showAnswer(answerId) {
            const answerElement = document.getElementById(answerId);
            if (answerElement) {
                const isHidden = answerElement.style.display === 'none';
                answerElement.style.display = isHidden ? 'block' : 'none';

                // ボタンテキストを変更
                const button = document.querySelector(`[onclick*="${answerId}"]`);
                if (button) {
                    const icon = button.querySelector('i');
                    const label = button.querySelector('.answer-toggle-label');
                    if (icon && label) {
                        if (isHidden) {
                            icon.className = 'fas fa-eye-slash';
                            label.textContent = '回答を非表示';
                        } else {
                            icon.className = 'fas fa-eye';
                            label.textContent = '回答を表示';
                        }
                    }
                }
            }
        }

        function toggleAnswer(answerId) {
            const answerElement = document.getElementById(answerId);
            if (answerElement) {
                const isHidden = answerElement.style.display === 'none';
                answerElement.style.display = isHidden ? 'block' : 'none';

                // ボタンテキストを変更
                const button = document.querySelector(`[onclick*="${answerId}"]`);
                if (button) {
                    const icon = button.querySelector('i');
                    const label = button.querySelector('.answer-toggle-label');
                    if (icon && label) {
                        if (isHidden) {
                            icon.className = 'fas fa-eye-slash';
                            label.textContent = '回答例を非表示';
                        } else {
                            icon.className = 'fas fa-eye';
                            label.textContent = '回答例を表示';
                        }
                    }
                }
            }
        }

        // コードブロックの構文ハイライト
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        });
    </script>

    <!-- Syntax Highlighting -->
    <script th:src="@{/webjars/prismjs/1.29.0/prism.min.js}"></script>
    <script th:src="@{/webjars/prismjs/1.29.0/components/prism-java.min.js}"></script>
    <script th:src="@{/webjars/prismjs/1.29.0/components/prism-sql.min.js}"></script>
</section>
</body>
</html>
