<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{_layouts/lecture}">
<head>
    <meta charset="UTF-8">
    <title th:text="${lecture.title}">Lecture</title>
    <link rel="stylesheet" th:href="@{/webjars/prismjs/themes/prism-tomorrow.css}">
</head>
<body class="bg-light text-dark">

<div layout:fragment="pageheader"
     th:replace="~{_fragments/headers :: page(title=${pageTitle}, breadcrumb=${breadcrumbs})}"></div>

<section layout:fragment="content">
    <main class="pt-5">
        <!-- 講義ヘッダー -->
        <header class="bg-primary text-white py-4 shadow">
            <div class="container px-4">
                <h1 class="text-center fw-bold mb-2">
                    <i class="fas fa-coffee me-2"></i>
                    <span th:text="${lecture.title}">講義タイトル</span>
                </h1>
                <p class="text-center text-light fs-5" th:text="${lecture.description}">講義説明</p>
                <div class="mt-3 text-center small">
                    <span class="badge bg-secondary me-2">
                        所要時間: <span th:text="${lecture.durationMinutes}">90</span>分
                    </span>
                    <span class="badge bg-secondary me-2"
                          th:if="${lecture.difficultyLevel}">
                        レベル: <span th:text="${lecture.difficultyLevel}">初級</span>
                    </span>
                    <span class="badge bg-secondary">
                        講義番号: <span th:text="${lecture.lectureNumber}">1</span>
                    </span>
                </div>
            </div>
        </header>

        <div class="container px-4 py-4">
            <input type="hidden" id="studentId" th:value="${studentId}">
            <!-- 学習目標セクション -->
            <section class="bg-white rounded shadow p-4 mb-4" th:if="${goals != null and !goals.isEmpty()}">
                <h2 class="fw-bold text-primary mb-4">
                    <i class="fas fa-target me-2"></i>本日の学習目標
                </h2>
                <div class="d-flex flex-column gap-3">
                    <div th:each="goal : ${goals}">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-check-circle text-primary me-2 mt-1"></i>
                            <span th:text="${goal.goalDescription}">学習目標項目</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- コンテンツチャプターセクション -->
            <div th:each="chapter, iterStat : ${contentChapters}" class="mb-4" th:if="${contentChapters != null and !contentChapters.isEmpty()}">
                <section class="bg-white rounded shadow p-4">
                    <h2 class="fw-bold mb-4 text-primary"
                        th:text="${chapter.chapterNumber + '. ' + chapter.title}">
                        チャプタータイトル
                    </h2>

                    <!-- チャプター説明 -->
                    <div th:if="${chapter.description}" class="mb-4">
                        <p th:text="${chapter.description}">チャプター説明</p>
                    </div>

                    <!-- チャプターの所要時間 -->
                    <div th:if="${chapter.durationMinutes}" class="mb-4">
                        <span class="badge bg-secondary">
                            所要時間: <span th:text="${chapter.durationMinutes}">30</span>分
                        </span>
                    </div>

                    <!-- このチャプターのコンテンツブロック -->
                    <th:block th:with="blocks=${chapterContentBlocks[chapter.id]}">
                        <div th:if="${blocks != null and !blocks.isEmpty()}">
                            <h3 class="fw-semibold mb-4 text-secondary">コンテンツ</h3>
                            <div th:each="block : ${blocks}" class="mb-4 p-4 border rounded">
                                <h4 class="fw-semibold text-dark mb-2" th:text="${block.title}">ブロックタイトル</h4>

                                <div class="bg-light p-3 rounded mb-3">
                                    <span class="fw-semibold text-muted text-uppercase small"
                                          th:text="${block.blockType}">ブロック種別</span>
                                </div>

                                <div th:if="${block.content}">
                                    <div th:switch="${#strings.toLowerCase(block.blockType)}">
                                        <!-- テキストコンテンツ -->
                                        <div th:case="'text'">
                                            <pre class="formatted-text" th:text="${block.content}">コンテンツ内容</pre>
                                        </div>

                                        <!-- コードブロック -->
                                        <div th:case="'code'" class="code-block mb-4">
                                            <pre><code class="language-java" th:text="${block.content}">コード内容</code></pre>
                                        </div>

                                        <!-- 画像 -->
                                        <div th:case="'image'" class="text-center">
                                            <img th:src="${block.content}" th:alt="${block.title}" class="img-fluid mx-auto d-block rounded">
                                        </div>

                                        <!-- リスト -->
                                        <div th:case="'list'">
                                            <pre class="formatted-text" th:text="${block.content}">リスト内容</pre>
                                        </div>

                                        <!-- その他のコンテンツ -->
                                        <div th:case="*">
                                            <pre class="formatted-text" th:text="${block.content}">その他のコンテンツ</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </th:block>

                    <!-- コンテンツブロックがない場合のメッセージ -->
                    <div th:if="${chapterContentBlocks[chapter.id] == null || chapterContentBlocks[chapter.id].isEmpty()}">
                        <p>この講義のコンテンツは現在準備中です。しばらくお待ちください。</p>
                    </div>
                </section>
            </div>

            <!-- 理解度テストセクション -->
            <section class="bg-white rounded shadow p-4 mb-4" th:if="${quizQuestionsByChapter != null and !quizQuestionsByChapter.isEmpty()}">
                <h2 class="fw-bold text-primary mb-4">
                    <i class="fas fa-question-circle me-2"></i>理解度テスト
                </h2>
                <div th:each="chapter : ${contentChapters}" th:if="${quizQuestionsByChapter[chapter.id] != null}">
                    <h3 class="fw-semibold mb-3" th:text="${chapter.chapterNumber + '. ' + chapter.title}"></h3>
                    <div th:each="quiz, quizStat : ${quizQuestionsByChapter[chapter.id]}" class="mb-4">
                        <h4 class="fw-semibold mb-2" th:text="${quiz.questionNumber + '. ' + quiz.questionText}">問題文</h4>
                        <ol class="quiz-options">
                            <li th:each="choice, stat : ${quiz.choiceList}">
                                <label class="d-flex align-items-center">
                                    <input class="me-2"
                                           th:attr="name=${'quiz-' + quiz.id},
                                                    value=${choice},
                                                    type=${quiz.questionType == 'MULTI' ? 'checkbox' : 'radio'}"/>
                                    <span class="me-2" th:text="${stat.count + '.'}"></span>
                                    <span th:text="${choice}"></span>
                                </label>
                            </li>
                        </ol>
                        <div class="mt-2">
                            <button class="btn btn-success quiz-submit-btn"
                                    th:data-quiz-id="${quiz.id}" th:data-question-id="${quiz.id}">回答送信</button>
                            <div th:id="'quiz-result-' + ${quiz.id}" class="mt-2"></div>
                        </div>
                        <div sec:authorize="hasAnyRole('ADMIN','INSTRUCTOR')">
                            <button class="btn btn-primary d-flex align-items-center gap-2 mt-2 show-answer-btn"
                                    th:attr="data-target-id=|quiz-answer${quizStat.count}|">
                                <i class="fas fa-eye"></i>
                                <span class="answer-toggle-label">回答を表示</span>
                            </button>
                            <div th:id="'quiz-answer' + ${quizStat.count}" class="answer-content">
                                <h4 class="fw-semibold mb-2">正解：<span class="text-danger" th:text="${quiz.correctAnswer}">1</span></h4>
                                <p th:if="${quiz.explanation}" class="mt-0" th:text="${quiz.explanation}">解説文</p>
                            </div>
                        </div>
                        <div class="quiz-answer-monitor mt-3" sec:authorize="hasRole('INSTRUCTOR')"
                             th:attr="data-question-id=${quiz.id}">
                            <h5 class="fw-bold text-primary mb-2">
                                <i class="fas fa-users me-2"></i>回答モニタ
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>学生名</th>
                                            <th>回答</th>
                                            <th>正誤</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 演習問題セクション -->
            <section class="bg-white rounded shadow p-4 mb-4" th:if="${exercisesByChapter != null and !exercisesByChapter.isEmpty()}">
                <h2 class="fw-bold text-primary mb-4">
                    <i class="fas fa-dumbbell me-2"></i>演習問題
                </h2>
                <div th:each="chapter : ${contentChapters}" th:if="${exercisesByChapter[chapter.id] != null}">
                    <h3 class="fw-semibold mb-3" th:text="${chapter.chapterNumber + '. ' + chapter.title}"></h3>
                    <div th:each="exercise, exStat : ${exercisesByChapter[chapter.id]}" class="border rounded p-4 mb-4">
                        <h4 class="fw-bold text-primary mb-3" th:text="${'演習問題' + exercise.questionNumber}">演習問題タイトル</h4>
                        <p class="mb-3" th:text="${exercise.questionText}">問題説明</p>
                        <div class="mb-3">
                            <textarea class="form-control" th:id="|exercise-input-${exercise.id}|" rows="3" placeholder="回答を入力してください"></textarea>
                        </div>
                        <button class="btn btn-success exercise-submit-btn"
                                th:attr="data-question-id=${exercise.id},data-lecture-id=${lecture.id}">
                            <i class="fas fa-paper-plane me-1"></i>送信
                        </button>
                        <div th:id="|exercise-result-${exercise.id}|" class="mt-2"></div>
                        <button sec:authorize="hasAnyRole('ADMIN','INSTRUCTOR')"
                                class="btn btn-primary d-flex align-items-center gap-2 toggle-answer-btn"
                                th:attr="data-target-id=|exercise-answer${exStat.count}|">
                            <i class="fas fa-eye"></i>
                            <span class="answer-toggle-label">回答例を表示</span>
                        </button>
                        <div sec:authorize="hasAnyRole('ADMIN','INSTRUCTOR')"
                             th:id="'exercise-answer' + ${exStat.count}"
                             class="answer-content">
                            <h4 class="fw-semibold mb-2">回答例：</h4>
                            <p th:text="${exercise.correctAnswer}">回答</p>
                            <p th:if="${exercise.explanation}" th:text="${exercise.explanation}">解説</p>
                        </div>
                        <div class="exercise-answer-monitor mt-3"
                             sec:authorize="hasRole('INSTRUCTOR')"
                             th:data-question-id="${exercise.id}">
                            <h5 class="fw-bold text-primary mb-2">
                                <i class="fas fa-user-check me-2"></i>演習回答一覧
                            </h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <ul class="exercise-student-list list-group"></ul>
                                </div>
                                <div class="col-md-8">
                                    <div class="exercise-answer-display border rounded p-3">受講者を選択してください</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- 追加リソース -->
            <section th:if="${additionalResources != null and !additionalResources.isEmpty()}" class="bg-white rounded shadow p-4 mb-4">
                <h2 class="fw-bold text-primary mb-4">
                    <i class="fas fa-link me-2"></i>追加学習リソース
                </h2>
                <div class="row row-cols-1 row-cols-md-2 g-4">
                    <div th:each="resource : ${additionalResources}" class="col">
                        <div class="border rounded p-4 h-100">
                            <h4 class="fw-semibold mb-2" th:text="${resource.title}">リソースタイトル</h4>
                            <p class="text-muted small mb-2" th:text="${resource.description}">説明</p>
                            <a th:href="${resource.url}" target="_blank"
                               class="text-primary small text-decoration-none">
                                <i class="fas fa-external-link-alt me-1"></i>
                                <span th:text="${resource.linkText ?: 'リンクを開く'}">リンクテキスト</span>
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ナビゲーション -->
            <section class="d-flex justify-content-between align-items-center bg-white rounded shadow p-4">
                <div>
                    <a th:if="${previousLecture}"
                       th:href="@{/lecture/{id}(id=${previousLecture.id})}"
                       class="btn btn-secondary d-inline-flex align-items-center px-4 py-2">
                        <i class="fas fa-arrow-left me-2"></i>
                        前の講義: <span th:text="${previousLecture.title}">前の講義</span>
                    </a>
                </div>
                <div>
                    <a th:if="${nextLecture}"
                       th:href="@{/lecture/{id}(id=${nextLecture.id})}"
                       class="btn btn-primary d-inline-flex align-items-center px-4 py-2">
                        次の講義: <span th:text="${nextLecture.title}">次の講義</span>
                        <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                </div>
            </section>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        // コードブロックの構文ハイライト
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        });
    </script>

    <!-- Syntax Highlighting -->
    <script th:src="@{/webjars/prismjs/prism.js}"></script>
    <script th:src="@{/webjars/prismjs/components/prism-java.js}"></script>
    <script th:src="@{/webjars/prismjs/components/prism-sql.js}"></script>
    <script type="module" th:src="@{/js/answer-toggle.js}"></script>
    <script th:src="@{/js/lecture-quiz.js}" type="module"></script>
    <script th:src='@{/js/lecture-exercise.js}' type="module"></script>
</section>
</body>
</html>
